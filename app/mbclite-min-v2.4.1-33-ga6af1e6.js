MBchat=function(){var d;var x;var m;var a=new Class({initialize:function(D,B,C){this.rid=D||0;this.name=B||"Entrance Hall";this.type=C||"O"},set:function(B){this.rid=B.rid;this.name=B.name;this.type=B.type}});var u;var i;var b;var z;var s;var t;var h;var w;var y;var r;var A=false;var g=new Request.Queue({stopOnFailure:false});var p=new Class({initialize:function(B,C){this.request=new Request.JSON({url:B,onComplete:function(D,E){if(D){C(D)}else{c(E)}}});g.addRequest(B,this.request)},transmit:function(B){this.request.post($merge(m,B))}});var f=function(C,B){var D=new Element("span",{"class":C.role,text:C.name});D.inject(B);return D};var c=function(B){var D;if(B){D='<span class="errorMessage">'+B+"</span>"}else{D='<span class="errorMessage">Server Error</span>'}var C=new Date();MBchat.updateables.message.displayMessage(0,C.getTime()/1000,s,D)};var j=function(B){return'<span class="chatBotMessage">'+B+"</span>"};var v=new p("message.php",function(B){});var n=new p("whisper.php",function(B){});var q=new p("private.php",function(B){});var o=function(){q.transmit({wid:this.getParent().get("id").substr(1).toInt(),lid:MBchat.updateables.poller.getLastId(),rid:u.rid})};var e;var l;var k=new p("login.php",function(B){A=true;MBchat.updateables.poller.init(l);MBchat.updateables.whispers.init(B.lastid.toInt());MBchat.updateables.online.show(0)});return{init:function(B,G,D,H,F,C){A=false;l=G;x=B;d=$("version").get("text");m={user:x.uid,password:x.password};z=0;s={uid:0,name:H,role:"C"};t=C;r=D;i=new a(0,F,"O");u=new a();u.set(i);var E=function(I){I.stop();if(z==0){v.transmit({rid:u.rid,lid:MBchat.updateables.poller.getLastId(),text:$("messageText").value})}else{n.transmit({wid:z,rid:u.rid,lid:MBchat.updateables.poller.getLastId(),text:$("messageText").value})}$("messageText").value=""};document.addEvent("keydown",function(I){if(!I.control){if(!I.alt){return}if(u.rid!=0){return}if(I.key=="0"){MBchat.updateables.online.show(0)}else{if($("R"+I.key)){MBchat.updateables.online.show(I.key.toInt())}}}else{if(I.key=="0"||I.key=="x"){if(z!=0){q.transmit({wid:0,lid:MBchat.updateables.poller.getLastId(),rid:u.rid})}else{if(u.rid==0){MBchat.logout();window.location="forum.php"}else{MBchat.updateables.message.leaveRoom()}}}else{if($("R"+I.key)){MBchat.updateables.message.enterRoom(I.key.toInt())}else{if(I.key=="s"){E(I)}}}}});h=new RegExp("(^|\\s|>)(((http)|(https)|(ftp)|(irc)):\\/\\/[^\\s<>]+)(?!<\\/a>)","gm");$("messageForm").addEvent("submit",function(I){E(I);return false});e=$("content").getCoordinates();window.addEvent("resize",function(){e=$("content").getCoordinates()});MBchat.updateables.init();k.transmit($merge({mbchat:d},MooTools,{browser:Browser.Engine.name+Browser.Engine.version,platform:Browser.Platform.name}))},logout:function(){if(A){MBchat.updateables.poller.logout();var B=new Request({url:"logout.php",autoCancel:true}).post($merge(m,{mbchat:d},MooTools,{browser:Browser.Engine.name+Browser.Engine.version,platform:Browser.Platform.name}))}A=false},updateables:function(){var B=function(C){return C.replace(h,function(F,E,D){return E+'<a href="'+D+'" onclick="window.open(this.href); return false;">'+D+"</a>"})};return{init:function(){MBchat.updateables.online.init();MBchat.updateables.message.init()},processMessage:function(C){MBchat.updateables.online.processMessage(C);MBchat.updateables.message.processMessage(C);MBchat.updateables.whispers.processMessage(C)},poller:function(){var E;var D;var I=null;var G=false;var H;var C=new Request.JSON({url:"read.php",link:"chain",onComplete:function(K){if(K){if(K.messages){MBchat.updateables.poller.pollResponse(K.messages)}if(G){C.post(m)}}else{MBchat.logout();window.location="forum.php"}}});var J=new p("presence.php",function(K){});var F=function(){J.transmit({})};return{init:function(K){presenceInterval=K.presence;E=K.poll;G=true},setLastId:function(K){if(!I){I=K;D=F.periodical(E,MBchat.updateables);if(G){C.post(m)}}else{I=(I>K)?K:I}},getLastId:function(){return I},start:function(){if(!G){G=true;C.post(m)}},pollResponse:function(K){K.each(function(L){L.lid=L.lid.toInt();L.rid=L.rid.toInt();L.user.uid=L.user.uid.toInt();var M=L.lid;I=(I<M)?M:I;if(G){MBchat.updateables.processMessage(L)}})},stop:function(){G=false},logout:function(){MBchat.updateables.poller.stop();$clear(D)}}}(),online:function(){var D;var H;var C;var I=-1;var E=function(){var K=D.firstChild;if(K){var J=0;do{K.removeClass("rowEven");K.removeClass("rowOdd");if(J%2==0){K.addClass("rowEven")}else{K.addClass("rowOdd")}J++}while(K=K.nextSibling)}};var G=function(J){var N=$("U"+J.uid);if(N){N.destroy()}N=new Element("div",{id:"U"+J.uid});var M=f(J,N);if(J.wid&&J.wid.toInt()!=0){if(J.uid!=x.uid){var L=$("W"+J.wid);if(!L){return null}}M.addClass("priv")}else{if(u.type==="M"){if(J.question){M.addClass("ask")}if(x.uid==J.uid){if(J.question){N.store("question",J.question);N.addClass("hasQuestion")}}}}if(J.uid!=x.uid&&x.whisperer&&((x.role!="B"&&J.role!="B")||(x.role==="B"&&J.role==="B"))){N.firstChild.addClass("whisperer");N.addEvent("keydown",function(P){if(!P.control){return}if(P.key=="w"){P.stop();var O=$$(".whisperBox");if(O.every(function(S,R){var U=S.get("id");var T=S.getElement(".whisperList").getChildren();if(T.length==1){if(T[0].get("id").substr(U.length+1).toInt()==J.uid){return false}}return true})){var Q=new p("newwhisper.php",function(S){if(S.wid!=0){var R=S.user;R.uid=R.uid.toInt();var T=createWhisperBox(S.wid.toInt(),R)}});Q.transmit({wuid:J.uid})}}})}var K=N.retrieve("question");if(K){N.inject(D,"top")}else{N.inject(D,"bottom")}E();return N};var F=function(K){var J=$("Q"+K.get("id").substr(1));if(J){J.destroy()}K.destroy();E()};onlineReq=new p("online.php",function(J){D.removeClass("loading");D.addClass(u.type);I=C;C=-1;D.empty();var K=J.online;if(K.length>0){K.each(function(L){L.uid=L.uid.toInt();G(L)})}H=J.lastid.toInt();MBchat.updateables.poller.setLastId(H)});return{init:function(){D=$("onlineList");H=null;I=-1},show:function(J){D.empty();D.erase("class");D.addClass("loading");onlineReq.transmit({rid:J});I=-1;C=J},getCurrentRid:function(){return I},processMessage:function(L){if(!H){return}var Q=L.lid;if(H<Q){H=Q;userDiv=$("U"+L.user.uid);var S;switch(L.type){case"LO":case"LT":if(x.uid==L.user.uid){k.transmit($merge({mbchat:d},MooTools,{browser:Browser.Engine.name+Browser.Engine.version,platform:Browser.Platform.name}))}else{if(userDiv){F(userDiv)}}break;case"LX":if(x.uid==L.user.uid){MBchat.logout();window.location="forum.php"}break;case"RX":if(I==0){if(!userDiv){userDiv=G(L.user);if(z!=0){S=$("W"+z+"U"+L.user.uid);if(S){userDiv.addClass("priv")}}}}else{if(userDiv){if(z==0){F(userDiv)}else{if(!userDiv.hasClass("priv")){F(userDiv)}}}}break;case"LI":if(!userDiv&&L.rid==I){G(L.user)}break;case"RE":if(I!=0){if(!userDiv&&L.rid==I){var O=L.user;O.question=L.message;userDiv=G(O);if(z!=0){S=$("W"+z+"U"+O.uid);if(S){userDiv.addClass("priv")}}}}else{if(userDiv){if(z==0){F(userDiv)}else{if(!userDiv.hasClass("priv")){F(userDiv)}}}}break;case"MQ":if(L.rid==I){if(u.type=="M"&&(x.mod=="M"||x.uid==L.user.uid)){var O=L.user;O.question=L.message;userDiv=G(O)}var T=userDiv.getElement("span");T.addClass("ask")}break;case"MR":case"ME":if(L.rid==I){var T=userDiv.getElement("span");T.removeClass("ask");if(u.type=="M"&&(x.mod=="M"||x.uid==L.user.uid)){G(L.user)}}break;case"RM":case"RN":if(L.rid==I){if(x.uid==L.user.uid){if(L.user.role=="M"){x.mod="M"}else{x.mod="N"}}G(L.user)}break;case"PE":var R=$("W"+L.rid);if(userDiv){if(L.user.uid!=x.uid){if(!R){MBchat.updateables.message.displayMessage(H,L.time,s,j(L.user.name+" Leaves the Room"));F(userDiv)}else{userDiv.addClass("priv")}}else{if(u.rid==0){var P=$("chatList");P.removeClass("whisper");P.addClass("chat");$("inputContainer").set("styles",{display:"block"});$("entranceHall").set("styles",{display:"none"})}$("roomNameContainer").empty();var K=new Element("h1",{"class":"privateRoom"}).set("text","Private Room").inject("roomNameContainer");var M=$$(".private");M.addClass("nonprivate");M.removeClass("private");z=L.rid.toInt();var N=R.getElement(".whisperList").getChildren();var J=$("onlineList").getChildren();J.each(function(U){if(N.some(function(V){return this.get("id").substr(1)==V.get("id").substr(R.get("id").length+1)},U)){U.addClass("priv")}});userDiv.addClass("priv");$("messageText").focus();R.setStyle("display","none");$("content").setStyles(e)}}else{var O=L.user;O.wid=L.rid;G(O)}break;case"PX":if(L.user.uid==x.uid){$("roomNameContainer").empty();var K=new Element("h1").set("text",u.name).inject("roomNameContainer");var M=$$(".nonprivate");M.addClass("private");M.removeClass("nonprivate");MBchat.updateables.online.show(u.rid);$("messageText").focus();if(u.rid==0){var P=$("chatList");P.removeClass("chat");P.addClass("whisper");$("inputContainer").set("styles",{display:"none"});$("entranceHall").set("styles",{display:"block"})}if($("W"+z)){$("W"+z).setStyle("display","block")}$("content").setStyles(e);z=0}else{MBchat.updateables.message.displayMessage(H,L.time,s,j(L.user.name+" Enters the Room"));G(L.user)}break;case"WJ":if(z==L.rid){userDiv=G(L.user);userDiv.addClass("priv")}break;case"WL":if(z==L.rid){userDiv.removeClass("priv")}break;default:break}}}}}(),message:function(){var D;var C;var E;return{init:function(){D=$("chatList");C=new Fx.Scroll(D,{link:"cancel"});E=null},enterRoom:function(F){E=null;D.removeClass("whisper");D.empty();D.addClass("chat");$("roomNameContainer").empty();$("inputContainer").set("styles",{display:"block"});$("entranceHall").set("styles",{display:"none"});u=new a(F,"Loading","I");var G=new p("room.php",function(H){H.room.rid=H.room.rid.toInt();u.set(H.room);H.messages.each(function(K){K.lid=K.lid.toInt();K.rid=K.rid.toInt();K.user.uid=K.user.uid.toInt();if(!E){E=K.lid-1}MBchat.updateables.processMessage(K)});E=H.lastid.toInt();MBchat.updateables.poller.setLastId(E);var J=new Element("h1").set("text",u.name).inject("roomNameContainer");if(u.type=="M"&&(x.mod=="M"||x.role=="H"||x.role=="G"||x.role=="S")){var I=$$(".whisperBox");I.each(function(L){var K=L.getElement(".private");K.removeClass("private");K.addClass("nonprivate");K.removeEvent("click",o)})}MBchat.updateables.online.show(u.rid);$("messageText").focus()}).transmit({rid:F})},leaveRoom:function(){E=null;var H=new p("exit.php",function(I){I.messages.each(function(J){J.lid=J.lid.toInt();J.rid=J.rid.toInt();J.user.uid=J.user.uid.toInt();if(!E){E=J.lid-1}MBchat.updateables.processMessage(J)});E=I.lastid.toInt();MBchat.updateables.poller.setLastId(E);MBchat.updateables.online.show(0)}).transmit({rid:u.rid});if(u.type=="M"&&(x.mod=="M"||x.role=="H"||x.role=="G"||x.role=="S")){var G=$$(".whisperBox");G.each(function(J){var I=J.getElement(".nonprivate");if(I){I.removeClass("nonprivate");I.addClass("private");I.addEvent("click",o)}})}u.set(i);D.removeClass("chat");D.empty();D.addClass("whisper");$("roomNameContainer").empty();var F=new Element("h1").set("text",u.name).inject("roomNameContainer");$("inputContainer").set("styles",{display:"none"});$("entranceHall").set("styles",{display:"block"})},processMessage:function(K){var I=K.lid.toInt();if(E<I){E=I;switch(K.type){case"RE":if(z==0){if(u.rid==0||K.rid==u.rid){if(u.rid==0){this.displayMessage(E,K.time,s,j(K.user.name+" leaves for a Room"))}else{this.displayMessage(E,K.time,s,j(K.user.name+" Enters the Room"))}}}break;case"RX":if(z==0){if(u.rid==0||K.rid==u.rid){if(u.rid==0){this.displayMessage(E,K.time,s,j(K.user.name+" Re-enters the Hall"))}else{this.displayMessage(E,K.time,s,j(K.user.name+" Leaves the Room"))}}}break;case"WH":if(MBchat.updateables.whispers.isWhisperingIn(K.rid)){if(z==0){var G=new Element("span",{"class":"whisper"});var F=false;if(x.uid==K.user.uid){G.appendText("(whispers to")}else{G.appendText("(whispers to me");F=true}var H="W"+K.rid;var J=$(H).getElement(".whisperList").getChildren();J.each(function(N){var M=N.get("id").substr(H.length+1).toInt();if(M!=K.user.uid){if(F){G.appendText(", ")}else{G.appendText(" ");F=true}var L=N.clone();L.inject(G)}});G.appendText(") ");this.displayMessage(E,K.time,K.user,G.get("html")+K.message)}else{this.displayMessage(E,K.time,K.user,"(private) "+K.message)}}break;case"WJ":if(K.user.uid!=x.uid&&MBchat.updateables.whispers.isWhisperingIn(K.rid)){this.displayMessage(E,K.time,s,j(K.user.name+" Joins your whisper box"))}break;case"WL":if(K.user.uid!=x.uid&&MBchat.updateables.whispers.isWhisperingIn(K.rid)){this.displayMessage(E,K.time,s,j(K.user.name+" Leaves your whisper box"))}break;default:break}}if(z==0){if(K.rid==u.rid){switch(K.type){case"ME":this.displayMessage(E,K.time,K.user,K.message);break;case"LT":this.displayMessage(E,K.time,s,j(K.user.name+" Logs Out (timeout)"));break;case"LI":this.displayMessage(E,K.time,s,j(K.user.name+" Logs In to Chat"));break;case"LO":this.displayMessage(E,K.time,s,j(K.user.name+" Logs Out"));break;case"RM":this.displayMessage(E,K.time,s,j(K.user.name+" Has been made a Moderator"));break;case"RN":this.displayMessage(E,K.time,s,j(K.user.name+" Is no longer a moderator"));break;default:break}}}},displayMessage:function(M,H,L,N,O){var I=function(R){R=R.toString();if(R.length<2){R="0"+R}return R};var F=new Element("div");if(M!=0){F.set("id","L"+M)}var J=new Date(H.toInt()*1000);var K=J.getHours();var Q=" am";if(K>12){Q=" pm";K=K-12}else{if(K==12){Q=" pm"}}var G=new Element("span",{"class":"time",text:I(K)+":"+I(J.getMinutes())+":"+I(J.getSeconds())+Q});G.inject(F);f(L,F);N=B(N);var P=new Element("span",{html:N});P.inject(F);if(!O){while(D.getChildren().length>=t){D.getFirst().destroy()}}if((!D.getLast())||(D.getLast().get("class")=="rowOdd")){F.addClass("rowEven")}else{F.addClass("rowOdd")}F.inject(D);C.toBottom()}}}(),whispers:function(){var I=null;var D=null;var C=null;var G=function(J,L){var O=L.get("id");var M=L.getElement(".whisperList");var N=M.getChildren();if(N.every(function(P){if(P.get("id").substr(O.length+1).toInt()==J.uid){return false}return true})){var K=f(J,M);K.addClass("whisperer");K.set("id",O+"U"+J.uid);return true}return false};var E=function(J,K){n.transmit({wid:K,rid:u.rid,lid:MBchat.updateables.poller.getLastId(),text:J.getElement(".whisperInput").value});J.getElement(".whisperInput").value=""};var H=function(U,N){var T=$("whisperBoxTemplate");var R=T.clone();R.addClass("whisperBox");R.set("id","W"+U);var K=R.getElement(".whisperList");K.addClass("loading");if(N){var S=f(N,K);S.addClass("whisperer");S.set("id","W"+U+"U"+N.uid)}var L=new p("getwhisperers.php",function(V){K.removeClass("loading");V.whisperers.each(function(W){W.uid=W.uid.toInt();if(x.uid!=W.uid){G(W,R)}})});L.transmit({wid:U});var J=R.getElement(".closeBox");var M=new p("leavewhisper.php",function(V){R.destroy();$("content").setStyles(e)});J.addEvent("click",function(V){M.transmit({wid:U})});var O=R.getElement(".private");if(u.type=="M"&&(x.mod=="M"||x.role=="H"||x.role=="G"||x.role=="S")){O.removeClass("private");O.addClass("nonprivate")}else{O.addEvent("click",o)}R.getElement("form").addEvent("submit",function(V){V.stop();E(R,U)});R.addEvent("keydown",function(W){if(!W.alt){return}switch(W.key){case"p":if(u.type!="M"||(x.mod!="M"&&x.role!="H"&&x.role!="G"&&x.role!="S")){W.stop();var V=o.bind(O);V()}break;case"s":W.stop();E(R,U);break;case"x":W.stop();M.transmit({wid:U});break;default:break}});R.addClass("wBactive");R.inject(document.body);C=R;var Q=R.getCoordinates();Q.top=Q.top+(Math.random()-0.5)*50;Q.left=Q.left+(Math.random()-0.5)*150;R.setStyles(Q);var P=new Drag(R,{handle:R.getElement(".dragHandle"),snap:0,onStart:function(V){if(C){C.removeClass("wBactive")}C=V;V.addClass("wBactive")},onComplete:function(V){V.getElement(".whisperInput").focus()}});$("content").setStyles(e);return R};var F=function(L,J){if(x.uid==J){L.destroy();$("content").setStyles(e)}else{var K=$(L.get("id")+"U"+J);if(K){K.destroy()}if(L.getElement(".whisperList").getChildren().length==0){L.destroy();$("content").setStyles(e)}}};return{init:function(J){I=J},processMessage:function(M){var L=M.lid.toInt();if(I<L){I=L;switch(M.type){case"WJ":if($$(".whisperBox").every(function(N){var O=N.get("id");if(O.substr(1).toInt()==M.rid){if(x.uid!=M.user.uid){G(M.user,N)}return false}return true})){if(x.uid==M.user.uid){H(M.rid.toInt())}}break;case"LT":case"LO":var K=$$(".whisperBox");if(K){K.each(function(N){F(N,M.user.uid)})}break;case"WL":var J=$("W"+M.rid);if(J){F(J,M.user.uid)}break;default:break}}},updateWhisperers:function(K,L){whisperBox=$("W"+K);if(whisperBox){var J=whisperBox.getElement(".whisperList");J.removeClass("loading");L.each(function(M){M.uid=M.uid.toInt();if(x.uid!=M.uid){G(M,whisperBox)}})}},isWhisperingIn:function(K){var J=$$(".whisperBox");return !J.every(function(L){if(K==L.get("id").substr(1).toInt()){return false}return true})}}}()}}(),goToRoom:function(B){MBchat.updateables.message.enterRoom(B)},exit:function(){if(z!=0){q.transmit({wid:0,lid:MBchat.updateables.poller.getLastId(),rid:u.rid})}else{if(u.rid==0){MBchat.logout();window.location="forum.php"}else{MBchat.updateables.message.leaveRoom()}}}}}();