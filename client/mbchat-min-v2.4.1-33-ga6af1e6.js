MBchat=function(){var d;var x;var m;var a=new Class({initialize:function(D,B,C){this.rid=D||0;this.name=B||"Entrance Hall";this.type=C||"O"},set:function(B){this.rid=B.rid;this.name=B.name;this.type=B.type}});var u;var i;var b;var z;var s;var t;var h;var w;var y;var r;var d;var A;var g=new Request.Queue({stopOnFailure:false});var p=new Class({initialize:function(B,C){this.request=new Request.JSON({url:B,onComplete:function(D,E){if(D){C(D)}else{c(E)}}});g.addRequest(B,this.request)},transmit:function(B){this.request.post($merge(m,B))}});var f=function(C,B){var D=new Element("span",{"class":C.role,text:C.name});D.inject(B);return D};var c=function(B){var D;if(B){D='<span class="errorMessage">'+B+"</span>"}else{D='<span class="errorMessage">Server Error</span>'}var C=new Date();MBchat.updateables.message.displayMessage(0,C.getTime()/1000,s,D)};var j=function(B){return'<span class="chatBotMessage">'+B+"</span>"};var v=new p("message.php",function(B){});var n=new p("whisper.php",function(B){});var q=new p("private.php",function(B){});var o=function(){q.transmit({wid:this.getParent().get("id").substr(1).toInt(),lid:MBchat.updateables.poller.getLastId(),rid:u.rid})};var e;var l;var k=new p("login.php",function(B){A=true;MBchat.updateables.poller.init(l);MBchat.updateables.whispers.init(B.lastid.toInt());MBchat.updateables.online.show(0)});return{init:function(G,F,M,B,K,L){A=false;r=M;l=F;d=$("version").get("text");x=G;m={user:x.uid,password:x.password};z=0;s={uid:0,name:B,role:"C"};t=L;i=new a(0,K,"O");u=new a();u.set(i);var D=$$(".rooms");var H=new Fx.Transition(Fx.Transitions.Bounce,6);D.each(function(Q,O){var R=Q.getElements(".room");var P=new Fx.Elements(R,{link:"cancel",duration:500,transition:H.easeOut});R.each(function(S,T){var U;S.addEvent("mouseenter",function(W){if(u.rid==0){var V={};V[T]={width:[S.getStyle("width").toInt(),219]};R.each(function(Z,Y){if(Z!=S){var X=Z.getStyle("width").toInt();if(X!=67){V[Y]={width:[X,67]}}}});P.start(V);MBchat.updateables.online.show(S.get("id").substr(1).toInt())}else{c("Debug - MouseEnter in Room")}});S.addEvent("mouseleave",function(W){var V={};R.each(function(X,Y){V[Y]={width:[X.getStyle("width").toInt(),105]}});P.start(V);if(u.rid==0){MBchat.updateables.online.show(0)}});S.addEvent("click",function(V){V.stop();if((V.control||V.shift)&&(x.role=="A"||x.role=="L"||u.hasClass("committee"))){MBchat.updateables.logger.startLog(S.get("id").substr(1).toInt(),S.get("text"))}else{MBchat.updateables.message.enterRoom(S.get("id").substr(1).toInt())}})})});var C=$("exit");var I=new Fx.Morph(C,{link:"cancel",duration:500,transition:H.easeOut});C.addEvent("mouseenter",function(O){I.start({width:100})});C.addEvent("mouseleave",function(O){I.start({width:50})});C.addEvent("click",function(O){O.stop();if(z!=0){q.transmit({wid:0,lid:MBchat.updateables.poller.getLastId(),rid:u.rid})}else{if(u.rid==0){if(this.hasClass("exit-r")){MBchat.updateables.logger.returnToEntranceHall(O)}else{MBchat.logout();window.location="forum.php"}}else{MBchat.updateables.message.leaveRoom()}}});var N=function(O){O.stop();if(z==0){v.transmit({rid:u.rid,lid:MBchat.updateables.poller.getLastId(),text:$("messageText").value})}else{n.transmit({wid:z,rid:u.rid,lid:MBchat.updateables.poller.getLastId(),text:$("messageText").value})}$("messageText").value="";MBchat.sounds.resetTimer()};h=new RegExp("(^|\\s|>)(((http)|(https)|(ftp)|(irc)):\\/\\/[^\\s<>]+)(?!<\\/a>)","gm");w=new Hash({});var E=":(";var J=$$("img.emoticon");J.each(function(R,Q){var P=R.get("alt").substr(1);var O='<img src="'+R.get("src")+'" alt="'+P+'" title="'+P+'" />';w.include(P,O);if(Q!=0){E+="|"}E+=P.replace(/\)/g,"\\)");R.addEvent("click",function(T){T.stop();var S=$("messageText");S.value+=":"+P;S.focus()})});E+=")";y=new RegExp(E,"gm");$("messageForm").addEvent("submit",function(O){N(O);return false});e=$("content").getCoordinates();window.addEvent("resize",function(){e=$("content").getCoordinates()});MBchat.sounds.init();MBchat.updateables.init();k.transmit($merge({mbchat:d},MooTools,{browser:Browser.Engine.name+Browser.Engine.version,platform:Browser.Platform.name}))},logout:function(){if(A){MBchat.updateables.poller.logout();var B=new Request({url:"logout.php",autoCancel:true}).post($merge(m,{mbchat:d},MooTools,{browser:Browser.Engine.name+Browser.Engine.version,platform:Browser.Platform.name}))}A=false},sounds:function(){var F=false;var G;var B;var E=true;var D={counter:30,start:30};var C=function(){if(this.counter>0){this.counter--}var H=6*$("soundDelay").value.toInt();if(isNaN(parseInt(H))){H=30;$("soundDelay").value="5";Cookie.write("soundDelay","5",{duration:50})}if(H!=this.start){this.counter+=H-this.start;this.start=H;if(this.counter<0){this.counter=0}Cookie.write("soundDelay",$("soundDelay").value.toString(),{duration:50})}if(!F&&soundReady){F=soundManager.getSoundById("music");F.options.onfinish=function(){E=true};F.volume=10}if(G.checked){if(E){soundManager.play("music");E=false}}else{if(!E){soundManager.stop("music");E=true}}};return{init:function(){var J=Cookie.read("soundDelay");if(isNaN(parseInt(J))){J="5"}Cookie.write("soundDelay",J,{duration:50});var K=J.toInt();D.start=6*K;D.counter=D.start;$("soundDelay").value=J;C.periodical(10000,D);G=$("musicEnabled");var H=Cookie.read("musicEnabled");if(!H){H="false";Cookie.write("musicEnabled",H,{duration:50})}if(H=="true"){G.checked=true}else{G.checked=false}G.addEvent("click",function(L){if(!G.checked){soundManager.stop("music");E=true;Cookie.write("musicEnabled","false",{duration:50})}else{Cookie.write("musicEnabled","true",{duration:50})}});B=$("soundEnabled");var I=Cookie.read("soundEnabled");if(!I){I="true";Cookie.write("soundEnabled",I,{duration:50})}if(I=="true"){B.checked=true}else{B.checked=false}B.addEvent("click",function(L){if(!B.checked){Cookie.write("soundEnabled","false",{duration:50})}else{Cookie.write("soundEnabled","true",{duration:50})}})},resetTimer:function(){D.counter=D.start},roomMove:function(){if(soundReady&&B.checked){if(u.rid==4){soundManager.play("creaky")}else{soundManager.play("move")}}},newWhisper:function(){if(soundReady&&B.checked){soundManager.play("whispers")}},messageArrives:function(){if(soundReady&&D.counter==0&&B.checked){soundManager.play("speak")}}}}(),updateables:function(){var B=function(D){return D.replace(y,function(E,F){return w.get(F)})};var C=function(D){return D.replace(h,function(G,F,E){return F+'<a href="'+E+'" onclick="window.open(this.href); return false;">'+E+"</a>"})};return{init:function(){MBchat.updateables.online.init();MBchat.updateables.message.init();MBchat.updateables.logger.init()},processMessage:function(D){MBchat.updateables.online.processMessage(D);MBchat.updateables.message.processMessage(D);MBchat.updateables.whispers.processMessage(D)},poller:function(){var F;var E;var J=null;var H=false;var I;var D=new Request.JSON({url:"read.php",link:"chain",onComplete:function(L){if(L){if(L.messages){MBchat.updateables.poller.pollResponse(L.messages)}if(H){D.post(m)}}else{MBchat.logout();window.location="forum.php"}}});var K=new p("presence.php",function(L){});var G=function(){K.transmit({})};return{init:function(L){presenceInterval=L.presence;F=L.poll;H=true},setLastId:function(L){if(!J){J=L;E=G.periodical(F,MBchat.updateables);if(H){D.post(m)}}else{J=(J>L)?L:J}},getLastId:function(){return J},start:function(){if(!H){H=true;D.post(m)}},pollResponse:function(L){L.each(function(M){M.lid=M.lid.toInt();M.rid=M.rid.toInt();M.user.uid=M.user.uid.toInt();var N=M.lid;J=(J<N)?N:J;if(H){MBchat.updateables.processMessage(M)}})},stop:function(){H=false},logout:function(){MBchat.updateables.poller.stop();$clear(E)}}}(),online:function(){var E;var I;var D;var J=-1;var F=function(){var L=E.firstChild;if(L){var K=0;do{L.removeClass("rowEven");L.removeClass("rowOdd");if(K%2==0){L.addClass("rowEven")}else{L.addClass("rowOdd")}K++}while(L=L.nextSibling)}};var H=function(K){var O=$("U"+K.uid);if(O){O.destroy()}O=new Element("div",{id:"U"+K.uid});var N=f(K,O);if(K.wid&&K.wid.toInt()!=0){if(K.uid!=x.uid){var M=$("W"+K.wid);if(!M){return null}}N.addClass("priv")}else{if(u.type==="M"){if(x.mod==="M"){if(K.uid!=x.uid){if(K.question){N.addClass("ask");O.store("question",K.question);O.addClass("hasQuestion")}O.addEvents({click:function(R){if(R.control){if(K.role!="M"){var Q=new p("promote.php",function(S){MBchat.updateables.poller.pollResponse(S)}).transmit({lid:MBchat.updateables.poller.getLastId(),rid:u.rid,puid:K.uid})}}else{var P=O.retrieve("question");if(P){var Q=new p("release.php",function(S){MBchat.updateables.poller.pollResponse(S)}).transmit({lid:MBchat.updateables.poller.getLastId(),rid:u.rid,quid:K.uid})}}},mouseenter:function(S){var R=O.getElement("span");if(!(R.hasClass("M")||R.hasClass("H")||R.hasClass("G")||R.hasClass("S"))){var P=new Element("div",{id:"Q"+K.uid});var Q=O.retrieve("question");if(Q){Q=C(Q);Q=B(Q);P.set("html","<p><b>Click to Release Question<br/>","Control Click to Promote</b></p>","<p>",Q,"</p>");P.setStyles({top:S.client.y,left:S.client.x-200})}else{P.set("html","<p><b>Control Click to Promote</b></p>");P.setStyles({top:S.client.y,left:S.client.x})}P.inject(document.body)}},mouseleave:function(Q){O.removeClass("hasQuestion");var P=$("Q"+K.uid);if(P){P.destroy()}}});O.firstChild.addClass("whisperer")}else{O.addEvent("click",function(Q){Q.stop();if(Q.control&&Q.alt){var P=new p("demote.php",function(R){MBchat.updateables.poller.pollResponse(R)}).transmit({lid:MBchat.updateables.poller.getLastId(),rid:u.rid})}})}}else{if(K.question){N.addClass("ask")}if(x.uid==K.uid){if(K.question){O.store("question",K.question);O.addClass("hasQuestion")}O.addEvents({mouseenter:function(S){var R=O.getElement("span");if(!(R.hasClass("M")||R.hasClass("H")||R.hasClass("G")||R.hasClass("S"))){var P=new Element("div",{id:"Q"+O.get("id").substr(1)});var Q=O.retrieve("question");if(Q){Q=C(Q);Q=B(Q);P.set("html","<p>",Q,"</p>");P.setStyles({top:S.client.y,left:S.client.x-200});O.addClass("hasQuestion");P.inject(document.body)}}},mouseleave:function(Q){var P=$("Q"+O.get("id").substr(1));if(P){P.destroy()}}})}}}}if(K.uid!=x.uid&&x.whisperer&&((x.role!="B"&&K.role!="B")||(x.role==="B"&&K.role==="B"))){N.addEvent("mousedown",function(P){MBchat.updateables.whispers.whisperWith(K,N,P)});O.firstChild.addClass("whisperer");O.addEvent("keydown",function(Q){if(!Q.control){return}if(Q.key=="w"){Q.stop();var P=$$(".whisperBox");if(P.every(function(T,S){var V=T.get("id");var U=T.getElement(".whisperList").getChildren();if(U.length==1){if(U[0].get("id").substr(V.length+1).toInt()==K.uid){return false}}return true})){var R=new p("newwhisper.php",function(T){if(T.wid!=0){var S=T.user;S.uid=S.uid.toInt();var U=createWhisperBox(T.wid.toInt(),S)}});R.transmit({wuid:K.uid})}}})}var L=O.retrieve("question");if(L){O.inject(E,"top")}else{O.inject(E,"bottom")}F();return O};var G=function(L){var K=$("Q"+L.get("id").substr(1));if(K){K.destroy()}L.destroy();F()};onlineReq=new p("online.php",function(K){E.removeClass("loading");E.addClass(u.type);J=D;D=-1;E.empty();var L=K.online;if(L.length>0){L.each(function(M){M.uid=M.uid.toInt();H(M)})}I=K.lastid.toInt();MBchat.updateables.poller.setLastId(I)});return{init:function(){E=$("onlineList");I=null;J=-1},show:function(K){E.empty();E.erase("class");E.addClass("loading");onlineReq.transmit({rid:K});J=-1;D=K},getCurrentRid:function(){return J},processMessage:function(N){if(!I){return}var S=N.lid;if(I<S){I=S;userDiv=$("U"+N.user.uid);var U;switch(N.type){case"LO":case"LT":if(x.uid==N.user.uid){k.transmit($merge({mbchat:d},MooTools,{browser:Browser.Engine.name+Browser.Engine.version,platform:Browser.Platform.name}))}else{if(userDiv){G(userDiv)}}break;case"LX":if(x.uid==N.user.uid){MBchat.logout();window.location="forum.php"}break;case"RX":if(J==0){if(!userDiv){userDiv=H(N.user);if(z!=0){U=$("W"+z+"U"+N.user.uid);if(U){userDiv.addClass("priv")}}}}else{if(userDiv){if(z==0){G(userDiv)}else{if(!userDiv.hasClass("priv")){G(userDiv)}}}}break;case"LI":if(!userDiv&&N.rid==J){H(N.user)}break;case"RE":if(J!=0){if(!userDiv&&N.rid==J){var Q=N.user;Q.question=N.message;userDiv=H(Q);if(z!=0){U=$("W"+z+"U"+Q.uid);if(U){userDiv.addClass("priv")}}}}else{if(userDiv){if(z==0){G(userDiv)}else{if(!userDiv.hasClass("priv")){G(userDiv)}}}}break;case"MQ":if(N.rid==J){if(u.type=="M"&&(x.mod=="M"||x.uid==N.user.uid)){var Q=N.user;Q.question=N.message;userDiv=H(Q)}var V=userDiv.getElement("span");V.addClass("ask")}break;case"MR":case"ME":if(N.rid==J){var V=userDiv.getElement("span");V.removeClass("ask");if(u.type=="M"&&(x.mod=="M"||x.uid==N.user.uid)){H(N.user)}}break;case"RM":case"RN":if(N.rid==J){if(x.uid==N.user.uid){if(N.user.role=="M"){x.mod="M"}else{x.mod="N"}}H(N.user)}break;case"PE":var T=$("W"+N.rid);if(userDiv){if(N.user.uid!=x.uid){if(!T){MBchat.updateables.message.displayMessage(I,N.time,s,j(N.user.name+" Leaves the Room"));MBchat.sounds.roomMove();G(userDiv)}else{userDiv.addClass("priv")}}else{if(u.rid==0){var R=$("chatList");R.removeClass("whisper");R.addClass("chat");$("inputContainer").set("styles",{display:"block"});$("emoticonContainer").set("styles",{display:"block"});$("entranceHall").set("styles",{display:"none"});var M=$("exit");M.addClass("exit-r");M.removeClass("exit-f")}$("roomNameContainer").empty();var L=new Element("h1",{"class":"privateRoom"}).set("text","Private Room").inject("roomNameContainer");var O=$$(".private");O.addClass("nonprivate");O.removeClass("private");z=N.rid.toInt();var P=T.getElement(".whisperList").getChildren();var K=$("onlineList").getChildren();K.each(function(W){if(P.some(function(X){return this.get("id").substr(1)==X.get("id").substr(T.get("id").length+1)},W)){W.addClass("priv")}});userDiv.addClass("priv");$("messageText").focus();MBchat.sounds.resetTimer();T.setStyle("display","none");$("content").setStyles(e);MBchat.sounds.roomMove()}}else{var Q=N.user;Q.wid=N.rid;H(Q)}break;case"PX":if(N.user.uid==x.uid){$("roomNameContainer").empty();var L=new Element("h1").set("text",u.name).inject("roomNameContainer");var O=$$(".nonprivate");O.addClass("private");O.removeClass("nonprivate");MBchat.updateables.online.show(u.rid);$("messageText").focus();if(u.rid==0){var R=$("chatList");R.removeClass("chat");R.addClass("whisper");$("inputContainer").set("styles",{display:"none"});$("emoticonContainer").set("styles",{display:"none"});$("entranceHall").set("styles",{display:"block"});var M=$("exit");M.addClass("exit-f");M.removeClass("exit-r")}MBchat.sounds.resetTimer();if($("W"+z)){$("W"+z).setStyle("display","block")}$("content").setStyles(e);z=0}else{MBchat.updateables.message.displayMessage(I,N.time,s,j(N.user.name+" Enters the Room"));H(N.user)}MBchat.sounds.roomMove();break;case"WJ":if(z==N.rid){userDiv=H(N.user);userDiv.addClass("priv")}break;case"WL":if(z==N.rid){userDiv.removeClass("priv")}break;default:break}}}}}(),message:function(){var E;var D;var F;return{init:function(){E=$("chatList");D=new Fx.Scroll(E,{link:"cancel"});F=null},enterRoom:function(H){F=null;E.removeClass("whisper");E.empty();E.addClass("chat");$("roomNameContainer").empty();$("inputContainer").set("styles",{display:"block"});$("emoticonContainer").set("styles",{display:"block"});$("entranceHall").set("styles",{display:"none"});var G=$("exit");G.addClass("exit-r");G.removeClass("exit-f");u=new a(H,"Loading","I");var I=new p("room.php",function(J){J.room.rid=J.room.rid.toInt();u.set(J.room);J.messages.each(function(M){M.lid=M.lid.toInt();M.rid=M.rid.toInt();M.user.uid=M.user.uid.toInt();if(!F){F=M.lid-1}MBchat.updateables.processMessage(M)});F=J.lastid.toInt();MBchat.updateables.poller.setLastId(F);var L=new Element("h1").set("text",u.name).inject("roomNameContainer");if(u.type=="M"&&(x.mod=="M"||x.role=="H"||x.role=="G"||x.role=="S")){var K=$$(".whisperBox");K.each(function(N){var M=N.getElement(".private");M.removeClass("private");M.addClass("nonprivate");M.removeEvent("click",o)})}MBchat.updateables.online.show(u.rid);$("messageText").focus()}).transmit({rid:H});MBchat.sounds.resetTimer()},leaveRoom:function(){F=null;var J=new p("exit.php",function(K){K.messages.each(function(L){L.lid=L.lid.toInt();L.rid=L.rid.toInt();L.user.uid=L.user.uid.toInt();if(!F){F=L.lid-1}MBchat.updateables.processMessage(L)});F=K.lastid.toInt();MBchat.updateables.poller.setLastId(F);MBchat.updateables.online.show(0)}).transmit({rid:u.rid});if(u.type=="M"&&(x.mod=="M"||x.role=="H"||x.role=="G"||x.role=="S")){var I=$$(".whisperBox");I.each(function(L){var K=L.getElement(".nonprivate");if(K){K.removeClass("nonprivate");K.addClass("private");K.addEvent("click",o)}})}u.set(i);E.removeClass("chat");E.empty();E.addClass("whisper");$("roomNameContainer").empty();var H=new Element("h1").set("text",u.name).inject("roomNameContainer");$("inputContainer").set("styles",{display:"none"});$("emoticonContainer").set("styles",{display:"none"});$("entranceHall").set("styles",{display:"block"});var G=$("exit");G.addClass("exit-f");G.removeClass("exit-r");MBchat.sounds.resetTimer()},processMessage:function(L){var J=L.lid.toInt();if(F<J){F=J;switch(L.type){case"RE":if(z==0){if(u.rid==0||L.rid==u.rid){if(u.rid==0){this.displayMessage(F,L.time,s,j(L.user.name+" leaves for a Room"))}else{this.displayMessage(F,L.time,s,j(L.user.name+" Enters the Room"))}MBchat.sounds.roomMove()}}break;case"RX":if(z==0){if(u.rid==0||L.rid==u.rid){if(u.rid==0){this.displayMessage(F,L.time,s,j(L.user.name+" Re-enters the Hall"))}else{this.displayMessage(F,L.time,s,j(L.user.name+" Leaves the Room"))}MBchat.sounds.roomMove()}}break;case"WH":if(MBchat.updateables.whispers.isWhisperingIn(L.rid)){if(z==0){var H=new Element("span",{"class":"whisper"});var G=false;if(x.uid==L.user.uid){H.appendText("(whispers to")}else{H.appendText("(whispers to me");G=true}var I="W"+L.rid;var K=$(I).getElement(".whisperList").getChildren();K.each(function(O){var N=O.get("id").substr(I.length+1).toInt();if(N!=L.user.uid){if(G){H.appendText(", ")}else{H.appendText(" ");G=true}var M=O.clone();M.inject(H)}});H.appendText(") ");this.displayMessage(F,L.time,L.user,H.get("html")+L.message)}else{this.displayMessage(F,L.time,L.user,"(private) "+L.message)}MBchat.sounds.messageArrives()}break;case"WJ":if(L.user.uid!=x.uid&&MBchat.updateables.whispers.isWhisperingIn(L.rid)){this.displayMessage(F,L.time,s,j(L.user.name+" Joins your whisper box"))}break;case"WL":if(L.user.uid!=x.uid&&MBchat.updateables.whispers.isWhisperingIn(L.rid)){this.displayMessage(F,L.time,s,j(L.user.name+" Leaves your whisper box"))}break;default:break}}if(z==0){if(L.rid==u.rid){switch(L.type){case"ME":this.displayMessage(F,L.time,L.user,L.message);MBchat.sounds.messageArrives();break;case"LT":this.displayMessage(F,L.time,s,j(L.user.name+" Logs Out (timeout)"));MBchat.sounds.roomMove();break;case"LI":this.displayMessage(F,L.time,s,j(L.user.name+" Logs In to Chat"));MBchat.sounds.roomMove();break;case"LO":this.displayMessage(F,L.time,s,j(L.user.name+" Logs Out"));MBchat.sounds.roomMove();break;case"RM":this.displayMessage(F,L.time,s,j(L.user.name+" Has been made a Moderator"));break;case"RN":this.displayMessage(F,L.time,s,j(L.user.name+" Is no longer a moderator"));break;default:break}}}},displayMessage:function(N,I,M,O,P){var J=function(S){S=S.toString();if(S.length<2){S="0"+S}return S};var G=new Element("div");if(N!=0){G.set("id","L"+N)}var K=new Date(I.toInt()*1000);var L=K.getHours();var R=" am";if(L>12){R=" pm";L=L-12}else{if(L==12){R=" pm"}}var H=new Element("span",{"class":"time",text:J(L)+":"+J(K.getMinutes())+":"+J(K.getSeconds())+R});H.inject(G);f(M,G);O=C(O);O=B(O);var Q=new Element("span",{html:O});Q.inject(G);if(!P){while(E.getChildren().length>=t){E.getFirst().destroy()}}if((!E.getLast())||(E.getLast().get("class")=="rowOdd")){G.addClass("rowEven")}else{G.addClass("rowOdd")}G.inject(E);if($("autoScroll").checked){D.toBottom()}}}}(),whispers:function(){var J=null;var E=null;var D=null;var H=function(K,M){var P=M.get("id");var N=M.getElement(".whisperList");var O=N.getChildren();if(O.every(function(Q){if(Q.get("id").substr(P.length+1).toInt()==K.uid){return false}return true})){var L=f(K,N);L.addClass("whisperer");L.set("id",P+"U"+K.uid);return true}return false};var F=function(K,L){n.transmit({wid:L,rid:u.rid,lid:MBchat.updateables.poller.getLastId(),text:K.getElement(".whisperInput").value});K.getElement(".whisperInput").value="";MBchat.sounds.resetTimer()};var I=function(V,O){var U=$("whisperBoxTemplate");var S=U.clone();S.addClass("whisperBox");S.set("id","W"+V);var L=S.getElement(".whisperList");L.addClass("loading");if(O){var T=f(O,L);T.addClass("whisperer");T.set("id","W"+V+"U"+O.uid)}var M=new p("getwhisperers.php",function(W){L.removeClass("loading");W.whisperers.each(function(X){X.uid=X.uid.toInt();if(x.uid!=X.uid){H(X,S)}})});M.transmit({wid:V});var K=S.getElement(".closeBox");var N=new p("leavewhisper.php",function(W){S.destroy();$("content").setStyles(e)});K.addEvent("click",function(W){N.transmit({wid:V})});var P=S.getElement(".private");if(u.type=="M"&&(x.mod=="M"||x.role=="H"||x.role=="G"||x.role=="S")){P.removeClass("private");P.addClass("nonprivate")}else{P.addEvent("click",o)}S.getElement("form").addEvent("submit",function(W){W.stop();F(S,V)});S.addEvent("keydown",function(X){if(!X.alt){return}switch(X.key){case"p":if(u.type!="M"||(x.mod!="M"&&x.role!="H"&&x.role!="G"&&x.role!="S")){X.stop();var W=o.bind(P);W()}break;case"s":X.stop();F(S,V);break;case"x":X.stop();N.transmit({wid:V});break;default:break}});S.addClass("wBactive");S.inject(document.body);D=S;var R=S.getCoordinates();R.top=R.top+(Math.random()-0.5)*50;R.left=R.left+(Math.random()-0.5)*150;S.setStyles(R);var Q=new Drag(S,{handle:S.getElement(".dragHandle"),snap:0,onStart:function(W){if(D){D.removeClass("wBactive")}D=W;W.addClass("wBactive")},onComplete:function(W){W.getElement(".whisperInput").focus()}});$("content").setStyles(e);return S};var G=function(M,K){if(x.uid==K){M.destroy();$("content").setStyles(e)}else{var L=$(M.get("id")+"U"+K);if(L){L.destroy()}if(M.getElement(".whisperList").getChildren().length==0){M.destroy();$("content").setStyles(e)}}};return{init:function(K){J=K},whisperWith:function(O,M,L){var P=M.getCoordinates();var S;if(u.rid==0&&z==0){S=$("chatList")}else{S=$("inputContainer")}var N=$$(".whisperBox");var K=new Element("div",{"class":"dragBox"});K.setStyles(P);var R=function(){K.destroy();$("content").setStyles(e)};M.addEvent("mouseup",R);f(O,K);var T=new Fx.Morph(K,{link:"cancel",duration:500,transition:Fx.Transitions.Quad.easeOut,onComplete:function(U){U.destroy();$("content").setStyles(e)}});K.inject(document.body);K.addEvent("mouseup",R);N.include(S);var Q=new Drag.Move(K,{droppables:N,onSnap:function(U){U.removeEvent("mouseup",R)},onDrop:function(V,X){N.removeClass("dragOver");if(X){if(X==S&&z==0){var W=$$(".whisperBox");if(W.every(function(aa,Z){var ac=aa.get("id");var ab=aa.getElement(".whisperList").getChildren();if(ab.length==1){if(ab[0].get("id").substr(ac.length+1).toInt()==O.uid){this.start(aa.getCoordinates());if(D){D.removeClass("wBactive")}D=aa;aa.addClass("wBactive");aa.getElement(".whisperInput").focus();return false}}return true},T)){var Y=new p("newwhisper.php",function(aa){if(aa.wid!=0){var Z=aa.user;Z.uid=Z.uid.toInt();var ab=I(aa.wid.toInt(),Z);T.start(ab.getCoordinates())}else{T.start($("onlineList").getCoordinates())}});Y.transmit({wuid:O.uid})}}else{if(X==S){X=$("W"+z);$("U"+O.uid).addClass("priv");T.start($("chatList").getCoordinates())}else{T.start(X.getCoordinates())}if(H(O,X)){var U=new p("joinwhisper.php",function(Z){});U.transmit({wuid:O.uid,wid:X.get("id").substr(1).toInt()})}}}else{T.start(P)}},onEnter:function(U,V){V.addClass("dragOver")},onLeave:function(U,V){V.removeClass("dragOver")}});Q.start(L);$("content").setStyles(e)},processMessage:function(N){var M=N.lid.toInt();if(J<M){J=M;switch(N.type){case"WJ":if($$(".whisperBox").every(function(O){var P=O.get("id");if(P.substr(1).toInt()==N.rid){if(x.uid!=N.user.uid){H(N.user,O)}return false}return true})){if(x.uid==N.user.uid){I(N.rid.toInt());MBchat.sounds.newWhisper()}}break;case"LT":case"LO":var L=$$(".whisperBox");if(L){L.each(function(O){G(O,N.user.uid)})}break;case"WL":var K=$("W"+N.rid);if(K){G(K,N.user.uid)}break;default:break}}},updateWhisperers:function(L,M){whisperBox=$("W"+L);if(whisperBox){var K=whisperBox.getElement(".whisperList");K.removeClass("loading");M.each(function(N){N.uid=N.uid.toInt();if(x.uid!=N.uid){H(N,whisperBox)}})}},isWhisperingIn:function(L){var K=$$(".whisperBox");return !K.every(function(M){if(L==M.get("id").substr(1).toInt()){return false}return true})}}}(),logger:function(){var K;var G;var J;var O;var aa;var T=1000;var L=60*T;var I=60*L;var P=6*I;var S=24*I;var X=7*S;var R;var Z;var H;var W;var ab=function(){aa.set("text",H.toLocaleString());O.set("text",new Date(H.getTime()-Z).toLocaleString())};var V=null;var Q;var Y=function(){var ac=Q;Q++;if(ac<r.secondstep){return T}if(ac<r.minutestep){return L}if(ac<r.hourstep){return I}if(ac<r.sixhourstep){return P}return S};var D;var U;var E=function(ad){var ac=function(ae){MBchat.updateables.message.displayMessage(ad.lid,ad.time,s,j(ad.user.name+" "+ae),true)};switch(ad.type){case"LI":ac("Logs In "+ad.message);break;case"LO":ac("Logs Out "+ad.message);break;case"LT":ac("Logs Out (timeout)");break;case"RE":ac("Enters Room");break;case"RX":ac("Leaves Room");break;case"RM":ac("Becomes Moderator");break;case"RN":ac("Steps Down from being Moderator");break;case"WJ":ac("Joins whisper no: "+ad.rid);break;case"WL":ac("Leaves whisper no: "+ad.rid);break;case"ME":MBchat.updateables.message.displayMessage(ad.lid,ad.time,ad.user,ad.message,true);break;case"WH":MBchat.updateables.message.displayMessage(ad.lid,ad.time,ad.user,"(whispers to :"+ad.rid+")"+ad.message,true);break;case"LH":ac("Reads Log");default:break}};var F=new p("log.php",function(ac){J.removeClass("loading");if(ac){ac.messages.each(function(ad){ad.lid=ad.lid.toInt();ad.rid=ad.rid.toInt();ad.user.uid=ad.user.uid.toInt();E(ad)})}});var M;var N=function(){J.empty();J.addClass("loading");F.transmit({rid:D,start:new Date(H.getTime()-Z).getTime()/1000,end:H.getTime()/1000})};return{init:function(){K=$("logControls");J=$("chatList");G=$("printLog");G.addEvent("click",function(ac){U+="&start="+new Date(H.getTime()-Z).getTime()/1000;U+="&end="+H.getTime()/1000;U+="&tzo="+H.getTimezoneOffset()*60;MBchat.logout();window.location="print.php?"+U});O=$("timeShowStartLog");aa=$("timeShowEndLog");r.minutestep+=r.secondstep;r.hourstep+=r.minutestep;r.sixhourstep+=r.hourstep;$("minusStartLog").addEvents({mousedown:function(ac){var ad=function(){Z+=Y();if(H.getTime()-Z<R){Z=H.getTime()-R}ab()};$clear(M);if(V){$clear(V)}Q=0;ad();V=ad.periodical(r.spinrate)},mouseup:function(ac){$clear(V);$clear(M);M=N.delay(r.fetchdelay)}});$("plusStartLog").addEvents({mousedown:function(ad){var ac=function(){if(Z>0){Z-=Y()}if(Z<0){Z=0}ab()};$clear(M);if(V){$clear(V)}Q=0;ac();V=ac.periodical(r.spinrate)},mouseup:function(ac){$clear(V);$clear(M);M=N.delay(r.fetchdelay)}});$("minusEndLog").addEvents({mousedown:function(ad){var ac=function(){var ae=Z;if(Z>0){Z-=Y()}if(Z<0){Z=0}H=new Date(H.getTime()-ae+Z);ab()};$clear(M);if(V){$clear(V)}Q=0;ac();V=ac.periodical(r.spinrate)},mouseup:function(ac){$clear(V);$clear(M);M=N.delay(r.fetchdelay)}});$("plusEndLog").addEvents({mousedown:function(ac){var ad=function(){var af=Z;var ae=new Date().getTime()-H.getTime()+af;Z+=Y();if(Z>ae){Z=ae}H=new Date(H.getTime()-af+Z);ab()};$clear(M);if(V){$clear(V)}Q=0;ad();V=ad.periodical(r.spinrate)},mouseup:function(ac){$clear(V);$clear(M);M=N.delay(r.fetchdelay)}})},startLog:function(ae,ac){D=ae;MBchat.updateables.poller.stop();J.removeClass("whisper");J.removeClass("chat");J.addClass("logging");J.empty();U="user="+x.uid+"&password="+x.password+"&rid="+ae+"&room="+ac;$("inputContainer").addClass("hide");$("emoticonContainer").addClass("hide");$("roomNameContainer").empty();$("entranceHall").addClass("hide");var ad=$("exit");ad.removeClass("exit-f");ad.addClass("exit-r");$("soundOptions").addClass("hide");$("onlineListContainer").addClass("hide");K.removeClass("hide");H=new Date();Z=I;R=H.getTime()-X;ab();M=N.delay(r.fetchdelay)},returnToEntranceHall:function(ac){ac.stop();K.addClass("hide");J.removeClass("logging");$("header").removeClass("hide");$("content").removeClass("hide");$("entranceHall").removeClass("hide");$("soundOptions").removeClass("hide");$("onlineListContainer").removeClass("hide");MBchat.updateables.poller.start();MBchat.updateables.message.leaveRoom()}}}()}}()}}();